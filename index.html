<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Battery Pro Final</title>
    <style>
        :root {
            --blue: linear-gradient(180deg, #3b82f6, #1d4ed8);
            --orange: linear-gradient(180deg, #fb923c, #ea580c);
            --red: linear-gradient(180deg, #ef4444, #991b1b);
        }
        * { box-sizing: border-box; }
        body {
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 100dvh; 
            background: #f1f5f9; 
            font-family: -apple-system, sans-serif;
            overflow: hidden;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        .battery {
            position: relative; 
            width: 340px; 
            height: 70dvh; 
            max-height: calc(100dvh - 240px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            background: #fff; 
            border-radius: 50px; 
            border: 4px solid #e2e8f0;
            overflow: hidden; 
            margin-bottom: 20px;
        }
        .fill {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
            background: var(--blue); transition: height 0.6s ease, background 0.4s; z-index: 1;
        }
        .warning .fill { background: var(--orange); }
        .critical .fill { background: var(--red); }

        .top-bar {
            position: absolute; top: 20px; left: 20px; right: 20px;
            background: rgba(255,255,255,0.9); border-radius: 20px; padding: 12px;
            z-index: 10; display: flex; justify-content: center; align-items: center;
        }
        .stat { flex: 1; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .sep { width: 1px; height: 20px; background: #cbd5e1; margin: 0 10px; }
        .v { font-weight: 800; font-size: 14px; color: #1e293b; display: block; }
        .l { font-size: 9px; color: #64748b; text-transform: uppercase; }

        #resetBtn {
            display: none;
            background: #ef4444;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 4px;
        }

        .max-acc { display: flex; flex-direction: column; align-items: center; cursor: pointer; margin-left: 10px; }
        .max-acc input { width: 14px; height: 14px; margin-top: 2px; }

        .grid {
            position: absolute; bottom: 15px; left: 15px; right: 15px;
            height: 25%; z-index: 20; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
        }
        .grid.expanded { height: 45%; grid-template-rows: repeat(3, 1fr); }
        
        .bubble {
            background: #fff; border: 3px solid #eee; border-radius: 18px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .bubble .amt { font-weight: 800; font-size: 14px; color: #1e293b; }
        .bubble .forecast { font-size: 8px; color: #94a3b8; margin-top: 2px; font-weight: 600; }
        
        .bubble.lifesaver { background: #f0fdf4 !important; }
        .bubble.safe-haven { background: #f5f3ff !important; border-color: #8b5cf6 !important; }

        .controls { 
            display: flex; 
            flex-direction: column;
            gap: 10px; 
            z-index: 30; 
            margin-bottom: 10px; 
            width: 340px; 
            max-width: calc(100vw - 32px);
        }
        .btn { 
            border: none; 
            padding: 18px 20px; 
            border-radius: 20px; 
            font-weight: 700; 
            cursor: pointer; 
            width: 100%;
        }
        .btn-boost { background: #1e293b; color: #fff; }
        .btn-skip { background: #fff; border: 2px solid #1e293b; transition: 0.3s; }
        .btn-skip.penalized { background: #fee2e2; border-color: #f87171; color: #b91c1c; }
        .btn-reroll { background: #f8fafc; border: 2px solid #cbd5e1; color: #64748b; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        #tg-banner {
            position: fixed; bottom: 0; width: 100%; background: #334155; color: #fff;
            font-size: 12px; text-align: center; padding: calc(8px + env(safe-area-inset-bottom)) 0 env(safe-area-inset-bottom); 
            z-index: 100; display: none;
        }
    </style>
</head>
<body>

    <div class="battery" id="bat">
        <div class="fill" id="fill"></div>
        <div class="top-bar">
            <div class="stat">
                <span class="l">Собрано</span>
                <span class="v" id="s_val" style="cursor:pointer">0</span>
                <button id="resetBtn">Сброс</button>
            </div>
            <div class="sep"></div>
            <div class="stat"><span class="l">День</span><span class="v" id="d_val">40</span></div>
            <div class="sep"></div>
            <div class="stat"><span class="l">Нужно</span><span class="v" id="r_val">100k</span></div>
            <div class="sep"></div>
            <label class="max-acc">
                <span class="l">MAX</span>
                <input type="checkbox" id="max_check">
            </label>
        </div>
        <div class="grid" id="grid"></div>
    </div>

    <div class="controls">
        <button class="btn btn-boost" id="boost">+19 000 ₽</button>
        <button class="btn btn-skip" id="skip">Пропустить день</button>
        <button class="btn btn-reroll" id="reroll">Переиграть сумму</button>
    </div>

    <div id="tg-banner">Открой через Telegram, чтобы сохранялся прогресс.</div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const GOAL = 100000;
        const KEY = "tracker_state_v1";
        let saved = 0, days = 40, skipCooldown = 0;
        let resetArmed = false;

        const clamp = (val, min, max) => Math.max(min, Math.min(max, Number(val) || 0));

        const TMAStorage = {
            debounceTimer: null,
            isAvailable() {
                const tg = window.Telegram?.WebApp;
                return !!(tg && (tg.initDataUnsafe?.user || tg.initData) && tg.CloudStorage);
            },
            loadState(defaultState) {
                return new Promise((resolve) => {
                    if (!this.isAvailable()) return resolve(defaultState);
                    window.Telegram.WebApp.CloudStorage.getItem(KEY, (err, value) => {
                        if (err || !value) return resolve(defaultState);
                        try {
                            const parsed = JSON.parse(value);
                            const d = Number(parsed.days);
                            resolve({
                                saved: clamp(parsed.saved, 0, GOAL),
                                days: Number.isFinite(d) ? d : 40, 
                                skipCooldown: Math.max(0, Number(parsed.skipCooldown) || 0),
                                max: !!parsed.max
                            });
                        } catch (e) {
                            resolve(defaultState);
                        }
                    });
                });
            },
            saveState(state) {
                if (!this.isAvailable()) return;
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    window.Telegram.WebApp.CloudStorage.setItem(KEY, JSON.stringify(state), (err, ok) => {
                        if (err || ok === false) console.error("CloudStorage Error:", {err, ok});
                    });
                }, 250);
            }
        };

        function persist() {
            TMAStorage.saveState({
                saved, days, skipCooldown,
                max: document.getElementById('max_check').checked
            });
        }

        function getBorder(amt) {
            const ratio = Math.min(Math.max((amt - 500) / 4000, 0), 1);
            return `rgb(${Math.floor(34+(225-34)*ratio)}, ${Math.floor(197+(38-197)*ratio)}, 90)`;
        }

        function render() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            if (saved >= GOAL) {
                grid.innerHTML = '<b style="grid-column:1/3;text-align:center;color:#22c55e">ЦЕЛЬ ДОСТИГНУТА!</b>';
                return;
            }
            if (days <= 0) {
                grid.innerHTML = '<b style="grid-column:1/3;text-align:center;color:#ef4444">ВРЕМЯ ВЫШЛО</b>';
                return;
            }

            const rem = GOAL - saved;
            const daily = rem / days;
            const isMax = document.getElementById('max_check').checked;
            const isCrit = daily > 4000;
            const isWarn = daily > 3000 || (days > 1 && (rem / (days - 1) > 3000));

            document.getElementById('bat').className = `battery ${isCrit?'critical':(isWarn?'warning':'')}`;
            grid.className = `grid ${(isWarn || isCrit) ? 'expanded' : ''}`;

            const maxLimit = isCrit ? 15000 : (isMax || isWarn ? 4000 : 3000);
            let minS = (days <= 15) ? (days <= 7 ? 1500 : 1000) : 500;
            if (days <= 5) minS = Math.max(minS, Math.floor(daily / 100) * 100);
            if (isMax) minS = 2000;

            const count = (isWarn || isCrit) ? 6 : 4;
            let used = new Set();
            let candidates = [];

            for (let i = 0; i < count; i++) {
                const isLifesaver = (isWarn || isCrit) && i < 2;
                let v = isLifesaver ? Math.ceil((daily + 400) / 100) * 100 : Math.ceil((minS + Math.random() * (maxLimit - minS)) / 100) * 100;
                while(used.has(v)) v += 100;
                if (isCrit && v < daily) v = Math.ceil(daily / 100) * 100 + (i * 200);
                const amt = Math.min(v, rem);
                used.add(amt);
                const nextDay = days > 1 ? (rem - amt) / (days - 1) : 0;
                candidates.push({ amt, nextDay, isLifesaver });
            }

            const minNext = Math.min(...candidates.map(c => c.nextDay));
            candidates.forEach(c => {
                const b = document.createElement('div');
                b.className = `bubble ${c.isLifesaver ? 'lifesaver' : ''} ${c.nextDay === minNext ? 'safe-haven' : ''}`;
                b.style.borderColor = getBorder(c.amt);
                b.innerHTML = `<span class="amt">+${c.amt.toLocaleString()} ₽</span>
                               <span class="forecast">Завтра: ${Math.round(c.nextDay).toLocaleString()}₽</span>`;
                b.onclick = () => {
                    if (days <= 10 && c.amt < daily && !isCrit) {
                        if(!confirm("Это увеличит нагрузку завтра. Продолжить?")) return;
                    }
                    apply(c.amt);
                };
                grid.appendChild(b);
            });
        }

        function apply(amt) {
            saved = Math.min(GOAL, saved + amt);
            days = Math.max(0, days - 1);
            if (skipCooldown > 0) skipCooldown--;
            persist();
            update();
        }

        function update() {
            document.getElementById('s_val').textContent = saved.toLocaleString();
            document.getElementById('d_val').textContent = days;
            document.getElementById('r_val').textContent = Math.max(0, Math.ceil((GOAL-saved)/1000)) + 'k';
            document.getElementById('fill').style.height = Math.min(100, (saved / GOAL * 100)) + '%';
            
            const isGameOver = saved >= GOAL || days <= 0;
            if (isGameOver) document.getElementById('bat').className = 'battery';

            const sBtn = document.getElementById('skip');
            sBtn.className = `btn btn-skip ${skipCooldown > 0 ? 'penalized' : ''}`;
            
            const rBtn = document.getElementById('reroll');
            rBtn.disabled = isGameOver;
            
            render();
        }

        document.getElementById('boost').onclick = () => apply(Math.min(19000, GOAL - saved));
        document.getElementById('skip').onclick = () => {
            if (days > 0) { days--; skipCooldown = 2; persist(); update(); }
        };
        document.getElementById('reroll').onclick = () => {
            if (saved < GOAL && days > 0) render();
        };
        document.getElementById('max_check').onchange = () => { persist(); render(); };

        document.getElementById('s_val').onclick = () => {
            resetArmed = !resetArmed;
            document.getElementById('resetBtn').style.display = resetArmed ? 'block' : 'none';
        };

        document.getElementById('resetBtn').onclick = () => {
            saved = 0; days = 40; skipCooldown = 0;
            document.getElementById('max_check').checked = false;
            resetArmed = false;
            document.getElementById('resetBtn').style.display = 'none';
            persist();
            update();
        };

        async function init() {
            if (!TMAStorage.isAvailable()) {
                document.getElementById('tg-banner').style.display = 'block';
            } else {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
            const state = await TMAStorage.loadState({ saved: 0, days: 40, skipCooldown: 0, max: false });
            saved = state.saved;
            days = state.days;
            skipCooldown = state.skipCooldown;
            document.getElementById('max_check').checked = state.max;
            update();
        }

        init();
    </script>
</body>
</html>
